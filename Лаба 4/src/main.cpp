// main.cpp - главный исполнительный модуль банковской системы
// Этот файл содержит функцию main и реализует консольный интерфейс пользователя

#include <iostream>           // Подключаем iostream для ввода/вывода
#include <memory>             // Подключаем memory для использования умных указателей
#include <limits>             // Подключаем limits для работы с пределами числовых типов
#include "Bank.h"            // Подключаем класс Bank для управления системой
#include "PremiumClient.h"   // Подключаем класс PremiumClient для создания премиум-клиентов

// Функция для безопасного считывания целого числа
int readInt() {
    int value;                                   // Переменная для хранения введённого значения
    while (!(std::cin >> value)) {              // Пока ввод не является числом
        std::cin.clear();                        // Очищаем флаг ошибки ввода
        std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Игнорируем неверный ввод до конца строки
        std::cout << "Неверный ввод. Попробуйте снова: "; // Просим ввести заново
    }
    return value;                                // Возвращаем считанное значение
}

// Функция для безопасного считывания числа с плавающей точкой
double readDouble() {
    double value;                                  // Переменная для хранения введённого значения
    while (!(std::cin >> value)) {                // Пока ввод не является числом
        std::cin.clear();                         // Очищаем флаг ошибки ввода
        std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Игнорируем некорректный ввод
        std::cout << "Неверный ввод. Попробуйте снова: "; // Просим ввести заново
    }
    return value;                                 // Возвращаем считанное значение
}

// Функция для считывания даты от пользователя
Date readDate() {
    std::cout << "Введите день: ";                      // Запрашиваем день
    int d = readInt();                                // Считываем день
    std::cout << "Введите месяц: ";                    // Запрашиваем месяц
    int m = readInt();                                // Считываем месяц
    std::cout << "Введите год: ";                     // Запрашиваем год
    int y = readInt();                                // Считываем год
    return Date(d, m, y);                             // Создаём и возвращаем объект Date
}

// Точка входа в программу
int main() {
    Bank bank;                                        // Создаём объект Bank для управления системой
    bool running = true;                              // Переменная для управления главным циклом
    while (running) {                                 // Главный цикл программы
        // Выводим меню
        std::cout << "\n--- Меню банковской системы ---\n";            // Выводим заголовок меню
        std::cout << "1. Добавить клиента\n";                        // Пункт меню: добавить клиента
        std::cout << "2. Добавить премиум-клиента\n";                // Пункт меню: добавить премиум-клиента
        std::cout << "3. Редактировать клиента\n";                       // Пункт меню: редактировать клиента
        std::cout << "4. Удалить клиента\n";                     // Пункт меню: удалить клиента
        std::cout << "5. Просмотреть клиентов\n";                      // Пункт меню: просмотр всех клиентов
        std::cout << "6. Открыть счёт\n";                      // Пункт меню: открыть счёт
        std::cout << "7. Закрыть счёт\n";                     // Пункт меню: закрыть счёт
        std::cout << "8. Пополнить счёт\n";                           // Пункт меню: пополнить счёт
        std::cout << "9. Снять средства\n";                          // Пункт меню: снять средства
        std::cout << "10. Перевести средства\n";                        // Пункт меню: перевести средства
        std::cout << "11. Просмотреть счета\n";                   // Пункт меню: просмотр всех счетов
        std::cout << "12. Просмотреть счета клиента\n";            // Пункт меню: просмотр счетов конкретного клиента
        std::cout << "13. Просмотреть транзакции\n";               // Пункт меню: просмотр транзакций
        std::cout << "14. Информация о банке\n";                       // Пункт меню: общая информация о банке
        std::cout << "0. Выход\n";                            // Пункт меню: выход из программы
        std::cout << "Выберите пункт: ";                    // Предлагаем выбрать пункт

        int choice = readInt();                               // Считываем выбранный пункт

        switch (choice) {                                     // Обрабатываем выбор пользователя
            case 1: { // Добавление обычного клиента
                std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Очищаем буфер ввода
                std::string firstName, lastName;            // Переменные для имени и фамилии
                std::cout << "Введите имя: ";         // Запрашиваем имя
                std::getline(std::cin, firstName);          // Считываем имя
                std::cout << "Введите фамилию: ";          // Запрашиваем фамилию
                std::getline(std::cin, lastName);           // Считываем фамилию
                std::string street, city, index, country;   // Переменные для адреса
                std::cout << "Введите улицу и дом: ";   // Запрашиваем улицу и дом
                std::getline(std::cin, street);             // Считываем улицу и дом
                std::cout << "Введите город: ";               // Запрашиваем город
                std::getline(std::cin, city);               // Считываем город
                std::cout << "Введите почтовый индекс: ";       // Запрашиваем почтовый индекс
                std::getline(std::cin, index);              // Считываем почтовый индекс
                std::cout << "Введите страну: ";            // Запрашиваем страну
                std::getline(std::cin, country);            // Считываем страну
                Address addr(street, city, index, country); // Создаём объект Address из введённых данных
                std::cout << "Введите дату регистрации:\n";  // Запрашиваем дату регистрации
                Date regDate = readDate();                  // Считываем дату регистрации
                // Создаём уникальный указатель на обычного клиента
                auto client = std::make_unique<Client>(firstName, lastName, addr, regDate);
                bank.addClient(std::move(client));         // Добавляем клиента в банк
                std::cout << "Клиент добавлен.\n";           // Подтверждаем добавление
                break;                                     // Выходим из блока case 1
            }
            case 2: { // Добавление премиум-клиента
                std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Очищаем буфер ввода
                std::string firstName, lastName;            // Переменные для имени и фамилии
                std::cout << "Введите имя: ";         // Запрашиваем имя
                std::getline(std::cin, firstName);          // Считываем имя
                std::cout << "Введите фамилию: ";          // Запрашиваем фамилию
                std::getline(std::cin, lastName);           // Считываем фамилию
                std::string street, city, index, country;   // Переменные для адреса
                std::cout << "Введите улицу и дом: ";   // Запрашиваем улицу и дом
                std::getline(std::cin, street);             // Считываем улицу и дом
                std::cout << "Введите город: ";               // Запрашиваем город
                std::getline(std::cin, city);               // Считываем город
                std::cout << "Введите почтовый индекс: ";       // Запрашиваем почтовый индекс
                std::getline(std::cin, index);              // Считываем почтовый индекс
                std::cout << "Введите страну: ";            // Запрашиваем страну
                std::getline(std::cin, country);            // Считываем страну
                Address addr(street, city, index, country); // Создаём объект Address
                std::cout << "Введите дату регистрации:\n";  // Запрашиваем дату регистрации
                Date regDate = readDate();                  // Считываем дату регистрации
                std::cout << "Введите уровень премиум (целое число): "; // Запрашиваем уровень премиум
                int level = readInt();                      // Считываем уровень
                std::cout << "Введите скидку (от 0 до 1): ";     // Запрашиваем процент скидки (от 0 до 1)
                double discount = readDouble();             // Считываем скидку
                // Создаём уникальный указатель на премиум-клиента
                auto client = std::make_unique<PremiumClient>(firstName, lastName, addr, regDate, level, discount);
                bank.addClient(std::move(client));         // Добавляем клиента в банк
                std::cout << "Премиум-клиент добавлен.\n";   // Подтверждаем добавление
                break;                                     // Завершаем обработку case 2
            }
            case 3: { // Редактирование клиента
                std::cout << "Введите ID клиента для редактирования: ";   // Запрашиваем ID клиента
                int id = readInt();                          // Считываем ID
                std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Очищаем буфер
                std::string firstName, lastName;            // Переменные для новых имени и фамилии
                std::cout << "Введите новое имя: ";     // Запрашиваем новое имя
                std::getline(std::cin, firstName);          // Считываем имя
                std::cout << "Введите новую фамилию: ";      // Запрашиваем новую фамилию
                std::getline(std::cin, lastName);           // Считываем фамилию
                std::string street, city, index, country;   // Переменные для нового адреса
                std::cout << "Введите новую улицу и дом: "; // Запрашиваем новую улицу и дом
                std::getline(std::cin, street);             // Считываем улицу
                std::cout << "Введите новый город: ";           // Запрашиваем новый город
                std::getline(std::cin, city);               // Считываем город
                std::cout << "Введите новый почтовый индекс: ";   // Запрашиваем новый индекс
                std::getline(std::cin, index);              // Считываем индекс
                std::cout << "Введите новую страну: ";        // Запрашиваем новую страну
                std::getline(std::cin, country);            // Считываем страну
                Address addr(street, city, index, country); // Создаём объект Address с новыми данными
                bank.editClient(id, firstName, lastName, addr); // Вызываем метод редактирования клиента
                break;                                       // Завершаем обработку case 3
            }
            case 4: { // Удаление клиента
                std::cout << "Введите ID клиента для удаления: "; // Запрашиваем ID клиента
                int id = readInt();                          // Считываем ID
                if (bank.removeClient(id)) {                 // Пытаемся удалить клиента
                    std::cout << "Клиент удалён.\n";       // Выводим сообщение при успехе
                } else {
                    std::cout << "Не удалось удалить клиента.\n"; // Выводим сообщение при неудаче
                }
                break;                                       // Завершаем обработку case 4
            }
            case 5: { // Просмотр всех клиентов
                bank.viewClients();                          // Вызываем метод вывода всех клиентов
                break;                                       // Завершаем обработку case 5
            }
            case 6: { // Открытие счёта
                std::cout << "Введите ID клиента: ";            // Запрашиваем ID клиента
                int clientId = readInt();                     // Считываем ID клиента
                std::cout << "Введите тип счёта (1 - расчётный, 2 - сберегательный): "; // Запрашиваем тип счёта
                int t = readInt();                            // Считываем выбранный тип
                AccountType type = (t == 2) ? AccountType::Savings : AccountType::Checking; // Определяем тип
                std::cout << "Введите начальный депозит: ";     // Запрашиваем начальный депозит
                double deposit = readDouble();                // Считываем сумму
                std::cout << "Введите дату открытия:\n";           // Запрашиваем дату открытия
                Date openDate = readDate();                   // Считываем дату
                bank.openAccount(clientId, type, deposit, openDate); // Открываем счёт
                break;                                       // Завершаем обработку case 6
            }
            case 7: { // Закрытие счёта
                std::cout << "Введите номер счёта для закрытия: "; // Запрашиваем номер счёта
                int accNum = readInt();                       // Считываем номер счёта
                bank.closeAccount(accNum);                    // Пытаемся закрыть счёт
                break;                                       // Завершаем обработку case 7
            }
            case 8: { // Пополнение счёта
                std::cout << "Введите номер счёта: ";        // Запрашиваем номер счёта
                int accNum = readInt();                       // Считываем номер счёта
                std::cout << "Введите сумму для пополнения: ";    // Запрашиваем сумму
                double amount = readDouble();                 // Считываем сумму
                bank.deposit(accNum, amount);                 // Выполняем пополнение
                break;                                       // Завершаем обработку case 8
            }
            case 9: { // Снятие средств
                std::cout << "Введите номер счёта: ";        // Запрашиваем номер счёта
                int accNum = readInt();                       // Считываем номер счёта
                std::cout << "Введите сумму для снятия: ";   // Запрашиваем сумму
                double amount = readDouble();                 // Считываем сумму
                bank.withdraw(accNum, amount);                // Выполняем снятие
                break;                                       // Завершаем обработку case 9
            }
            case 10: { // Перевод средств
                std::cout << "Введите номер счёта отправителя: ";  // Запрашиваем номер счёта отправителя
                int fromAcc = readInt();                      // Считываем номер счёта отправителя
                std::cout << "Введите номер счёта получателя: ";    // Запрашиваем номер счёта получателя
                int toAcc = readInt();                        // Считываем номер счёта получателя
                std::cout << "Введите сумму перевода: ";   // Запрашиваем сумму перевода
                double amount = readDouble();                 // Считываем сумму
                bank.transfer(fromAcc, toAcc, amount);        // Выполняем перевод
                break;                                       // Завершаем обработку case 10
            }
            case 11: { // Просмотр всех счетов
                bank.viewAccounts();                          // Выводим информацию о всех счетах
                break;                                       // Завершаем обработку case 11
            }
            case 12: { // Просмотр счетов конкретного клиента
                std::cout << "Введите ID клиента: ";            // Запрашиваем ID клиента
                int clientId = readInt();                     // Считываем ID клиента
                auto accounts = bank.getClientAccounts(clientId); // Получаем список счетов клиента
                if (accounts.empty()) {                      // Проверяем, есть ли счета
                    std::cout << "У данного клиента нет счетов.\n"; // Выводим сообщение, если счетов нет
                } else {
                    for (auto *acc : accounts) {            // Перебираем все счета клиента
                        acc->displayInfo();                 // Выводим информацию о счёте
                        std::cout << "-----------------------------\n"; // Разделяем счета
                    }
                }
                break;                                       // Завершаем обработку case 12
            }
            case 13: { // Просмотр всех транзакций
                bank.viewTransactions();                     // Выводим информацию о всех транзакциях
                break;                                       // Завершаем обработку case 13
            }
            case 14: { // Вывод общей информации о банке
                bank.printBankInfo();                       // Выводим общую статистику
                break;                                      // Завершаем обработку case 14
            }
            case 0: { // Выход из программы
                running = false;                            // Устанавливаем флаг завершения программы
                std::cout << "Выход из программы.\n";         // Выводим сообщение о выходе
                break;                                      // Завершаем обработку case 0
            }
            default: { // Обработка неверного выбора
                std::cout << "Неверный пункт. Попробуйте снова.\n"; // Выводим сообщение об ошибке
                break;                                      // Завершаем обработку default
            }
        }
    }
    return 0; // Возвращаем 0, завершая выполнение программы
}
